<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sand Erosion Analysis | Riser Offshore Platform</title>
    <!-- Chosen Palette: Slate Gray, Sky Blue, and Warm Sand -->
    <!-- Application Structure Plan:
        - A top-level header with the report title and a clear status summary.
        - A navigation bar for quick access to different sections (Dashboard, Analysis, Methodology). This promotes easy exploration.
        - A main dashboard section ("Erosion Dashboard") to present the most critical information at a glance: the current calculated erosion rate shown in a prominent gauge chart, alongside the key input parameters. This immediately answers the primary question of the report.
        - An interactive "Sensitivity Analysis" section. This is the core of the application, allowing users to manipulate sliders for sand content, flow rate, pipe dimensions, and water cut to see the direct impact on the erosion rate. A dynamic line chart visualizes these relationships, making the data from the report's tables much more intuitive and engaging. This design encourages user exploration and a deeper understanding of the system's sensitivity.
        - A "Methodology & Key Factors" section that provides the context and theory from the report, explaining the "how" and "why" behind the calculations using clear, digestible cards. This builds confidence in the results.
        - A "Conclusions & Recommendations" section to summarize the findings and actionable insights, reinforcing the report's key takeaways.
        - The structure is designed to guide the user from the main result (the "what"), to interactive exploration (the "what-if"), to the underlying theory (the "how"), and finally to the actionable conclusion (the "so what").
    -->
    <!-- Visualization & Content Choices:
        - Main Erosion Rate: Goal is to inform and give a quick status. A Chart.js doughnut chart styled as a gauge is perfect for this, providing an immediate visual cue (safe, caution, danger). Library: Chart.js.
        - Key Parameters Display: Goal is to inform. Simple, bold text in styled cards is clear and effective.
        - Sensitivity Analysis: Goal is to allow exploration and show relationships. Interactive sliders for input and a dynamic Chart.js line chart to visualize the output. The chart will update in real-time as the user adjusts the sliders, which is a highly effective way to demonstrate the non-linear impact of velocity, the linear impact of sand content, and the assumed impact of water cut. This directly replaces static tables with an engaging tool. Library: Chart.js.
        - Key Influencing Factors: Goal is to organize and explain. A flexbox-based card layout with icons (using Font Awesome) and short descriptions makes the information from the report's background section easy to scan and digest.
        - All visualizations are canvas-based, adhering to the requirements.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        .gauge-value {
            position: absolute;
            top: 55%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            font-weight: bold;
        }
        .gauge-label {
            position: absolute;
            top: 75%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            color: #6b7280;
        }
        .tab-active {
            border-bottom: 2px solid #3b82f6;
            color: #3b82f6;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <header class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-4 lg:px-6 py-4">
            <div class="flex flex-wrap justify-between items-center">
                <a href="#" class="flex items-center">
                    <span class="text-xl font-semibold text-slate-700">Riser Offshore Platform | Sand Erosion Analysis</span>
                </a>
                <div class="hidden lg:flex items-center space-x-8 text-sm font-medium">
                    <a href="#dashboard" class="text-gray-600 hover:text-blue-600 transition-colors">Dashboard</a>
                    <a href="#sensitivity" class="text-gray-600 hover:text-blue-600 transition-colors">Sensitivity Analysis</a>
                    <a href="#methodology" class="text-gray-600 hover:text-blue-600 transition-colors">Methodology</a>
                    <a href="#conclusion" class="text-gray-600 hover:text-blue-600 transition-colors">Conclusion</a>
                </div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto p-4 md:p-8">
        
        <!-- Dashboard Section -->
        <section id="dashboard" class="mb-12 scroll-mt-20">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-800 mb-2">Erosion Dashboard</h1>
            <p class="text-lg text-slate-600 mb-8">Live erosion rate assessment for the production header based on current operational data.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Gauge Chart -->
                <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-lg flex flex-col items-center justify-center">
                    <h2 class="text-xl font-semibold text-slate-700 mb-4 self-start">Current Estimated Erosion Rate</h2>
                    <div class="relative w-full max-w-sm h-64">
                        <canvas id="erosionGauge"></canvas>
                        <div id="gaugeValue" class="gauge-value">0.10</div>
                        <div class="gauge-label">mm/year</div>
                    </div>
                </div>

                <!-- Key Parameters -->
                <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="font-semibold text-slate-500">Fluid Velocity</h3>
                        <p class="text-3xl font-bold text-blue-600 mt-2" id="velocityDisplay">1.17 m/s</p>
                        <p class="text-sm text-slate-400 mt-1">Based on 20,000 bbl/day flow</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="font-semibold text-slate-500">Sand Content</h3>
                        <p class="text-3xl font-bold text-blue-600 mt-2" id="sandContentDisplay">50 ppm</p>
                        <p class="text-sm text-slate-400 mt-1">Parts Per Million by Weight</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="font-semibold text-slate-500">Water Cut</h3>
                        <p class="text-3xl font-bold text-blue-600 mt-2" id="waterCutDisplay">40%</p>
                        <p class="text-sm text-slate-400 mt-1">Volume Percentage</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="font-semibold text-slate-500">Integrity Status</h3>
                        <p class="text-3xl font-bold text-green-500 mt-2" id="statusDisplay">Acceptable</p>
                        <p class="text-sm text-slate-400 mt-1">Monitoring Recommended</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Sensitivity Analysis Section -->
        <section id="sensitivity" class="mb-12 scroll-mt-20">
            <h2 class="text-3xl md:text-4xl font-bold text-slate-800 mb-2">Interactive Sensitivity Analysis</h2>
            <p class="text-lg text-slate-600 mb-8">Use the sliders and dropdowns to see how changes in pipe dimensions, sand content, flow rate, and water cut affect the erosion rate. This helps understand the operational limits of the system.</p>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Controls -->
                <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-lg">
                    <h3 class="text-xl font-semibold text-slate-700 mb-6">Simulation Controls</h3>
                    
                    <div class="space-y-6">
                        <div>
                            <label for="npsSelect" class="block mb-2 font-medium text-slate-600">Pipe NPS</label>
                            <select id="npsSelect" class="w-full p-2 border border-slate-300 rounded-lg bg-white text-slate-700 focus:ring-blue-500 focus:border-blue-500">
                                <option value="NPS 4">NPS 4</option>
                                <option value="NPS 6">NPS 6</option>
                                <option value="NPS 8">NPS 8</option>
                                <option value="NPS 10">NPS 10</option>
                                <option value="NPS 12">NPS 12</option>
                                <option value="NPS 14">NPS 14</option>
                                <option value="NPS 16">NPS 16</option>
                                <option value="NPS 18">NPS 18</option>
                                <option value="NPS 20">NPS 20</option>
                                <option value="NPS 22">NPS 22</option>
                                <option value="NPS 24">NPS 24</option>
                            </select>
                        </div>
                        <div>
                            <label for="scheduleSelect" class="block mb-2 font-medium text-slate-600">Schedule No.</label>
                            <select id="scheduleSelect" class="w-full p-2 border border-slate-300 rounded-lg bg-white text-slate-700 focus:ring-blue-500 focus:border-blue-500">
                                <option value="SCH 40">SCH 40</option>
                                <option value="SCH 80">SCH 80</option>
                            </select>
                        </div>
                        <div>
                            <label for="sandSlider" class="block mb-2 font-medium text-slate-600">Sand Content (ppm)</label>
                            <input id="sandSlider" type="range" min="0" max="800" value="50" step="1" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                            <div class="flex justify-between text-sm text-slate-500 mt-1">
                                <span>0</span>
                                <span id="sandSliderValue" class="font-bold">50 ppm</span>
                                <span>800</span>
                            </div>
                        </div>

                        <div>
                            <label for="flowRateSlider" class="block mb-2 font-medium text-slate-600">Flow Rate (bbl/day)</label>
                            <input id="flowRateSlider" type="range" min="5000" max="200000" value="20000" step="100" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                            <div class="flex justify-between text-sm text-slate-500 mt-1">
                                <span>5k</span>
                                <span id="flowRateSliderValue" class="font-bold">20,000 bbl/day</span>
                                <span>200k</span>
                            </div>
                        </div>

                        <div>
                            <label for="waterCutSlider" class="block mb-2 font-medium text-slate-600">Water Cut (%)</label>
                            <input id="waterCutSlider" type="range" min="5" max="100" value="40" step="1" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                            <div class="flex justify-between text-sm text-slate-500 mt-1">
                                <span>5%</span>
                                <span id="waterCutSliderValue" class="font-bold">40%</span>
                                <span>100%</span>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 border-t pt-6">
                        <h4 class="font-semibold text-slate-700 mb-2">Calculated Results:</h4>
                        <p class="text-lg">Pipe ID: <span id="calcPipeID" class="font-bold text-blue-600">0.20 m</span></p>
                        <p class="text-lg">Velocity: <span id="calcVelocity" class="font-bold text-blue-600">1.17 m/s</span></p>
                        <p class="text-lg">Erosion Rate: <span id="calcErosion" class="font-bold text-blue-600">0.10 mm/year</span></p>
                    </div>
                </div>

                <!-- Chart -->
                <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-slate-700">Erosion Rate vs. Process Variables</h3>
                        <div>
                            <button id="showSandChart" class="tab-button tab-active px-4 py-2 text-sm font-medium rounded-l-md bg-slate-100 hover:bg-slate-200 transition">vs. Sand</button>
                            <button id="showVelocityChart" class="tab-button px-4 py-2 text-sm font-medium bg-slate-100 hover:bg-slate-200 transition">vs. Velocity</button>
                            <button id="showWaterCutChart" class="tab-button px-4 py-2 text-sm font-medium rounded-r-md bg-slate-100 hover:bg-slate-200 transition">vs. Water Cut</button>
                        </div>
                    </div>
                    <div class="chart-container" style="height:40vh; max-height: 400px; min-height: 300px;">
                        <canvas id="sensitivityChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Methodology Section -->
        <section id="methodology" class="mb-12 scroll-mt-20">
            <h2 class="text-3xl md:text-4xl font-bold text-slate-800 mb-2">Calculation Methodology</h2>
            <p class="text-lg text-slate-600 mb-8">The assessment is based on the principles of the DNVGL-RP-O501 standard, using a proven empirical model to predict erosion.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="font-semibold text-lg text-slate-700 mb-2">Erosion Formula</h3>
                    <div class="text-center bg-slate-100 p-4 rounded-md my-4">
                        <p class="font-mono text-xl text-slate-800">ER = K ⋅ C<sub>sand</sub> ⋅ V<sup>n</sup></p>
                    </div>
                    <ul class="space-y-2 text-slate-600">
                        <li><span class="font-semibold">ER:</span> Erosion Rate (mm/year)</li>
                        <li><span class="font-semibold">K:</span> Empirical Erosion Constant (1330) - *Adjusted by Water Cut for sensitivity analysis*</li>
                        <li><span class="font-semibold">C<sub>sand</sub>:</span> Sand Concentration (fraction)</li>
                        <li><span class="font-semibold">V:</span> Fluid Velocity (m/s)</li>
                        <li><span class="font-semibold">n:</span> Velocity Exponent (2.5)</li>
                    </ul>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="font-semibold text-lg text-slate-700 mb-2">Key Influencing Factors</h3>
                    <p class="text-slate-600 mb-4">Erosion is a complex process. While our model focuses on velocity and sand content, other factors also play a critical role in the real-world erosion of pipeline components.</p>
                     <ul class="space-y-3 text-slate-600">
                        <li class="flex items-start"><i class="fas fa-ruler-combined fa-fw mt-1 mr-3 text-blue-500"></i><span><strong class="font-semibold">Particle Size & Shape:</strong> Sharper, larger particles cause more damage.</span></li>
                        <li class="flex items-start"><i class="fas fa-tint fa-fw mt-1 mr-3 text-blue-500"></i><span><strong class="font-semibold">Fluid Properties:</strong> Density and viscosity of the oil/water mixture affect how particles are carried and impact the pipe wall.</span></li>
                        <li class="flex items-start"><i class="fas fa-cogs fa-fw mt-1 mr-3 text-blue-500"></i><span><strong class="font-semibold">Pipe Geometry:</strong> Bends, tees, and reducers are critical points where erosion is often accelerated due to direct impingement.</span></li>
                        <li class="flex items-start"><i class="fas fa-shield-alt fa-fw mt-1 mr-3 text-blue-500"></i><span><strong class="font-semibold">Material Hardness:</strong> The pipe material's resistance to wear, in this case, Carbon Steel.</span></li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Conclusion Section -->
        <section id="conclusion" class="bg-white p-8 rounded-lg shadow-lg scroll-mt-20">
            <h2 class="text-3xl font-bold text-slate-800 mb-4">Conclusion & Recommendations</h2>
            <div class="space-y-4 text-slate-700">
                <p>The analysis indicates a base case erosion rate of **0.10 mm/year** for the Platform's production header under current operating conditions. While this rate is at the industry's threshold for concern, it does **not indicate an immediate or severe erosion threat**, assuming adequate initial wall thickness and corrosion allowance.</p>
                <p>The sensitivity analysis clearly demonstrates that the erosion rate is highly sensitive to increases in fluid velocity. A small increase in production rate can lead to a disproportionately large increase in erosion, highlighting the importance of operating within established velocity limits.</p>
                <p class="font-semibold mt-4">Key Recommendations:</p>
                <ul class="list-disc list-inside space-y-2 pl-4">
                    <li>**Continuous Monitoring:** Implement real-time sand detection and periodic ultrasonic thickness (UT) measurements to verify model predictions and track actual wall loss.</li>
                    <li>**Maintain Sand Control:** Ensure upstream sand control systems (e.g., gravel packs, screens) are functioning optimally to keep sand production below the 50 ppm design basis.</li>
                    <li>**Optimize Flow Velocity:** Carefully manage production rates to avoid exceeding the calculated erosional velocity limits, particularly during well startups or clean-up operations.</li>
                    <li>**Integrity Management:** Integrate these findings into the platform's integrity management plan, establishing clear action thresholds for inspection, maintenance, and potential operational adjustments.</li>
                </ul>
                <p class="mt-4">By adhering to these proactive measures, the Platform can effectively manage the risk of sand erosion, ensuring the long-term safety and reliability of its production infrastructure.</p>
            </div>
        </section>

    </main>
    
    <footer class="bg-slate-800 text-white mt-12 py-4">
        <div class="container mx-auto text-center text-sm">
            <p>&copy; Platform Integrity Department. This is a simulated report for illustrative purposes.</p>
        </div>
    </footer>


    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- DATA & CONSTANTS ---
            const config = {
                // Pipe diameter will now be looked up based on NPS and Schedule
                oilDensity: 850, // kg/m3
                waterDensity: 1020, // kg/m3
                erosionConstantK: 1330,
                velocityExponentN: 2.5,
                bblToM3: 0.158987,
                dayToSeconds: 86400
            };

            // ASME B36.10M / B36.19M nominal pipe dimensions (Internal Diameter in meters)
            // A simplified subset for common NPS and Schedules
            const pipeDimensions = {
                "NPS 4": {
                    "SCH 40": 0.1023, // 4.026 inches
                    "SCH 80": 0.0972, // 3.826 inches
                },
                "NPS 6": {
                    "SCH 40": 0.1541, // 6.065 inches
                    "SCH 80": 0.1463, // 5.761 inches
                },
                "NPS 8": {
                    "SCH 40": 0.2027, // 7.981 inches
                    "SCH 80": 0.1937, // 7.625 inches
                },
                "NPS 10": {
                    "SCH 40": 0.2545, // 10.020 inches
                    "SCH 80": 0.2428, // 9.564 inches
                },
                "NPS 12": {
                    "SCH 40": 0.3048, // 12.000 inches
                    "SCH 80": 0.2890, // 11.375 inches
                },
                "NPS 14": {
                    "SCH 40": 0.3440, // 13.542 inches
                    "SCH 80": 0.3238, // 12.750 inches
                },
                "NPS 16": {
                    "SCH 40": 0.3904, // 15.370 inches
                    "SCH 80": 0.3714, // 14.625 inches
                },
                "NPS 18": {
                    "SCH 40": 0.4370, // 17.202 inches
                    "SCH 80": 0.4160, // 16.376 inches
                },
                "NPS 20": {
                    "SCH 40": 0.4889, // 19.250 inches
                    "SCH 80": 0.4667, // 18.376 inches
                },
                "NPS 22": {
                    "SCH 40": 0.5397, // 21.250 inches
                    "SCH 80": 0.5143, // 20.250 inches
                },
                "NPS 24": {
                    "SCH 40": 0.5905, // 23.250 inches
                    "SCH 80": 0.5619, // 22.125 inches
                }
            };
            
            const state = {
                flowRateBblDay: 20000,
                sandContentPPM: 50,
                waterCutPercent: 40,
                pipeNPS: 'NPS 8',
                pipeSchedule: 'SCH 40',
                activeChart: 'sand' // 'sand', 'velocity', or 'watercut'
            };

            // --- CHART INSTANCES ---
            let gaugeChart, sensitivityChart;

            // --- UI ELEMENTS ---
            const npsSelect = document.getElementById('npsSelect');
            const scheduleSelect = document.getElementById('scheduleSelect');
            const sandSlider = document.getElementById('sandSlider');
            const flowRateSlider = document.getElementById('flowRateSlider');
            const waterCutSlider = document.getElementById('waterCutSlider');

            const sandSliderValue = document.getElementById('sandSliderValue');
            const flowRateSliderValue = document.getElementById('flowRateSliderValue');
            const waterCutSliderValue = document.getElementById('waterCutSliderValue');

            const calcPipeID = document.getElementById('calcPipeID');
            const calcVelocity = document.getElementById('calcVelocity');
            const calcErosion = document.getElementById('calcErosion');
            const gaugeValueEl = document.getElementById('gaugeValue');
            const statusDisplayEl = document.getElementById('statusDisplay');
            const velocityDisplayEl = document.getElementById('velocityDisplay');
            const sandContentDisplayEl = document.getElementById('sandContentDisplay');
            const waterCutDisplayEl = document.getElementById('waterCutDisplay');


            // --- CALCULATION FUNCTIONS ---
            const getPipeInternalDiameter = (nps, schedule) => {
                return pipeDimensions[nps] ? pipeDimensions[nps][schedule] : null;
            };

            const calculateFluidVelocity = (flowRate, nps, schedule) => {
                const pipe_id_m = getPipeInternalDiameter(nps, schedule);
                if (!pipe_id_m) {
                    console.error("Invalid NPS or Schedule combination. Defaulting to 0.2m ID.");
                    return 0; // Prevent division by zero, handle error gracefully
                }
                const q_m3_s = (flowRate * config.bblToM3) / config.dayToSeconds;
                const area = Math.PI * (pipe_id_m / 2) ** 2;
                return q_m3_s / area;
            };

            const calculateErosionRate = (sandPPM, velocity, waterCutPercent) => {
                const sandFraction = sandPPM / 1_000_000;
                let K_effective = config.erosionConstantK;

                // Illustrative Water Cut Factor:
                // Assume erosion rate reduces with higher water cut due to increased water wetting.
                // This is a simplified empirical assumption for demonstration of sensitivity.
                // In DNVGL-RP-O501, water cut influences K factor, flow regime, and particle behavior in complex ways.
                if (waterCutPercent !== undefined && waterCutPercent >=5 && waterCutPercent <= 100) {
                    // Linear reduction from K at 5% water cut to K * 0.7 at 100% water cut
                    const minWaterCut = 5;
                    const maxWaterCut = 100;
                    const maxReductionFactor = 0.3; // 30% reduction at 100% water cut
                    
                    if (waterCutPercent > minWaterCut) {
                        const reduction = ((waterCutPercent - minWaterCut) / (maxWaterCut - minWaterCut)) * maxReductionFactor;
                        K_effective = config.erosionConstantK * (1 - reduction);
                    }
                }

                return K_effective * sandFraction * (velocity ** config.velocityExponentN);
            };

            // --- UPDATE FUNCTIONS ---
            const updateDashboard = (pipeID, velocity, erosionRate, sandPPM, waterCut) => {
                velocityDisplayEl.textContent = `${velocity.toFixed(2)} m/s`;
                sandContentDisplayEl.textContent = `${sandPPM.toFixed(0)} ppm`;
                waterCutDisplayEl.textContent = `${waterCut.toFixed(0)}%`;
                gaugeValueEl.textContent = erosionRate.toFixed(2);
                
                // Update gauge chart data
                // Max value for gauge is 0.5 mm/year for visual scaling
                gaugeChart.data.datasets[0].data = [erosionRate, Math.max(0, 0.5 - erosionRate)];
                
                // Update status text and color
                if (erosionRate > 0.25) {
                    statusDisplayEl.textContent = 'High Risk';
                    statusDisplayEl.className = 'text-3xl font-bold text-red-500 mt-2';
                    gaugeChart.data.datasets[0].backgroundColor = ['#EF4444', '#E5E7EB'];
                } else if (erosionRate > 0.1) {
                    statusDisplayEl.textContent = 'Caution';
                    statusDisplayEl.className = 'text-3xl font-bold text-yellow-500 mt-2';
                    gaugeChart.data.datasets[0].backgroundColor = ['#F59E0B', '#E5E7EB'];
                } else {
                    statusDisplayEl.textContent = 'Acceptable';
                    statusDisplayEl.className = 'text-3xl font-bold text-green-500 mt-2';
                    gaugeChart.data.datasets[0].backgroundColor = ['#22C55E', '#E5E7EB'];
                }
                gaugeChart.update('none');
            };

            const updateInteractiveDisplay = (pipeID, velocity, erosionRate, sandPPM, flowRate, waterCut) => {
                calcPipeID.textContent = `${pipeID.toFixed(3)} m`;
                sandSliderValue.textContent = `${sandPPM.toFixed(0)} ppm`;
                flowRateSliderValue.textContent = `${flowRate.toLocaleString()} bbl/day`;
                waterCutSliderValue.textContent = `${waterCut.toFixed(0)}%`;
                calcVelocity.textContent = `${velocity.toFixed(2)} m/s`;
                calcErosion.textContent = `${erosionRate.toFixed(2)} mm/year`;
            };

            const updateSensitivityChart = () => {
                let labels, data, xlabel, pointLabel, borderColor, backgroundColor;
                const currentPipeID = getPipeInternalDiameter(state.pipeNPS, state.pipeSchedule);
                const currentVelocity = calculateFluidVelocity(state.flowRateBblDay, state.pipeNPS, state.pipeSchedule);
                const currentErosionRate = calculateErosionRate(state.sandContentPPM, currentVelocity, state.waterCutPercent);

                let currentPointX = null;
                let currentPointY = currentErosionRate;

                // Ensure the second dataset for the current point exists
                if (sensitivityChart.data.datasets.length < 2) {
                    sensitivityChart.data.datasets.push({
                        label: 'Current Operating Point',
                        data: [],
                        fill: false,
                        pointRadius: 8,
                        pointBackgroundColor: '#FFD700', // Gold color for the dot
                        pointBorderColor: '#000',
                        pointBorderWidth: 2,
                        showLine: false, // Only show the point, not a line
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = 'Current Erosion Rate: ';
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(2) + ' mm/year';
                                    }
                                    return label;
                                }
                            }
                        }
                    });
                }

                if (state.activeChart === 'sand') {
                    const sandRange = Array.from({ length: 20 }, (_, i) => 0 + i * (800 / 19)); // Updated range
                    labels = sandRange.map(s => s.toFixed(0));
                    data = sandRange.map(s => calculateErosionRate(s, currentVelocity, state.waterCutPercent));
                    xlabel = 'Sand Content (ppm by weight)';
                    pointLabel = 'Erosion Rate (mm/year)';
                    borderColor = 'rgba(59, 130, 246, 1)';
                    backgroundColor = 'rgba(59, 130, 246, 0.2)';
                    currentPointX = state.sandContentPPM;
                } else if (state.activeChart === 'velocity') {
                    const flowRateRange = Array.from({ length: 20 }, (_, i) => 5000 + i * (195000 / 19)); // Updated range
                    const velocityRange = flowRateRange.map(fr => calculateFluidVelocity(fr, state.pipeNPS, state.pipeSchedule));
                    labels = velocityRange.map(v => v.toFixed(2));
                    data = velocityRange.map(v => calculateErosionRate(state.sandContentPPM, v, state.waterCutPercent));
                    xlabel = 'Fluid Velocity (m/s)';
                    pointLabel = 'Erosion Rate (mm/year)';
                    borderColor = 'rgba(239, 68, 68, 1)';
                    backgroundColor = 'rgba(239, 68, 68, 0.2)';
                    currentPointX = currentVelocity;
                } else { // 'watercut'
                    const waterCutRange = Array.from({ length: 20 }, (_, i) => 5 + i * (95 / 19));
                    labels = waterCutRange.map(wc => wc.toFixed(0) + '%');
                    data = waterCutRange.map(wc => calculateErosionRate(state.sandContentPPM, currentVelocity, wc));
                    xlabel = 'Water Cut (%)';
                    pointLabel = 'Erosion Rate (mm/year)';
                    borderColor = 'rgba(16, 185, 129, 1)'; // Green for water cut
                    backgroundColor = 'rgba(16, 185, 129, 0.2)';
                    currentPointX = state.waterCutPercent;
                }

                sensitivityChart.data.labels = labels;
                sensitivityChart.data.datasets[0].data = data;
                sensitivityChart.data.datasets[0].label = pointLabel;
                sensitivityChart.data.datasets[0].borderColor = borderColor;
                sensitivityChart.data.datasets[0].backgroundColor = backgroundColor;
                sensitivityChart.data.datasets[0].pointBackgroundColor = borderColor;
                sensitivityChart.options.scales.x.title.text = xlabel;
                
                // Update the current point's data
                if (currentPointX !== null) {
                    sensitivityChart.data.datasets[1].data = [{ x: currentPointX, y: currentPointY }];
                } else {
                    sensitivityChart.data.datasets[1].data = []; // Clear if no specific X for current point
                }
                sensitivityChart.update();
            };

            const updateAll = () => {
                const pipeID = getPipeInternalDiameter(state.pipeNPS, state.pipeSchedule);
                const velocity = calculateFluidVelocity(state.flowRateBblDay, state.pipeNPS, state.pipeSchedule);
                const erosionRate = calculateErosionRate(state.sandContentPPM, velocity, state.waterCutPercent);
                
                updateDashboard(pipeID, velocity, erosionRate, state.sandContentPPM, state.waterCutPercent);
                updateInteractiveDisplay(pipeID, velocity, erosionRate, state.sandContentPPM, state.flowRateBblDay, state.waterCutPercent);
                updateSensitivityChart();
            };

            // --- CHART INITIALIZATION ---
            const initCharts = () => {
                const gaugeCtx = document.getElementById('erosionGauge').getContext('2d');
                gaugeChart = new Chart(gaugeCtx, {
                    type: 'doughnut',
                    data: {
                        datasets: [{
                            data: [0.1, 0.4],
                            backgroundColor: ['#F59E0B', '#E5E7EB'],
                            borderWidth: 0,
                            circumference: 180,
                            rotation: 270,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '80%',
                        plugins: {
                            tooltip: { enabled: false }
                        }
                    }
                });

                const sensitivityCtx = document.getElementById('sensitivityChart').getContext('2d');
                sensitivityChart = new Chart(sensitivityCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Erosion Rate (mm/year)',
                            data: [],
                            fill: false,
                            borderColor: 'rgba(59, 130, 246, 1)',
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            tension: 0.1,
                            pointRadius: 4,
                            pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                            pointBorderColor: '#fff',
                            pointHoverRadius: 6,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Erosion Rate (mm/year)', font: { size: 14 } }
                            },
                            x: {
                                title: { display: true, text: 'Sand Content (ppm by weight)', font: { size: 14 } }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    title: function(context) {
                                        return context[0].label;
                                    },
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += context.parsed.y.toFixed(2) + ' mm/year';
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            };

            // --- EVENT LISTENERS ---
            npsSelect.addEventListener('change', (e) => {
                state.pipeNPS = e.target.value;
                updateAll();
            });

            scheduleSelect.addEventListener('change', (e) => {
                state.pipeSchedule = e.target.value;
                updateAll();
            });

            sandSlider.addEventListener('input', (e) => {
                state.sandContentPPM = parseFloat(e.target.value);
                updateAll();
            });

            flowRateSlider.addEventListener('input', (e) => {
                state.flowRateBblDay = parseFloat(e.target.value);
                updateAll();
            });

            waterCutSlider.addEventListener('input', (e) => {
                state.waterCutPercent = parseFloat(e.target.value);
                updateAll();
            });

            document.getElementById('showSandChart').addEventListener('click', (e) => {
                state.activeChart = 'sand';
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('tab-active'));
                e.target.classList.add('tab-active');
                updateSensitivityChart();
            });

            document.getElementById('showVelocityChart').addEventListener('click', (e) => {
                state.activeChart = 'velocity';
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('tab-active'));
                e.target.classList.add('tab-active');
                updateSensitivityChart();
            });

            document.getElementById('showWaterCutChart').addEventListener('click', (e) => {
                state.activeChart = 'watercut';
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('tab-active'));
                e.target.classList.add('tab-active');
                updateSensitivityChart();
            });

            // --- INITIALIZATION ---
            initCharts();
            // Set initial values for dropdowns
            npsSelect.value = state.pipeNPS;
            scheduleSelect.value = state.pipeSchedule;
            updateAll();

        });
    </script>
</body>
</html>
